<section class="flex max-w-7xl w-full m-auto justify-between items-center">
  <h1>Aforshow 2025</h1>
  <nav>
    <ul class="flex gap-4">
      <li><a href="/">Inicio</a></li>
      <li><a href="/schedule">Horario</a></li>
      <li><a href="/speakers">Charlas</a></li>
      <li><a href="/ticket">Ticket</a></li>
      <li><a href="/faq">FAQ</a></li>
    </ul>
  </nav>
  <button id="login-btn">Login con Discord</button>
  <div id="user-info" class="flex items-center gap-2">
    <div
      id="supabase-config"
      data-url={import.meta.env.PUBLIC_SUPABASE_URL}
      data-key={import.meta.env.PUBLIC_SUPABASE_ANON_KEY}
    >
    </div>
  </div>
</section>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const config = document.getElementById("supabase-config");
  const SUPABASE_URL = config.dataset.url;
  const SUPABASE_ANON_KEY = config.dataset.key;

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  async function loginWithDiscord() {
    await supabase.auth.signInWithOAuth({ provider: "discord" });
  }

  document
    .getElementById("login-btn")
    ?.addEventListener("click", loginWithDiscord);

  async function checkSession() {
    const {
      data: { session },
    } = await supabase.auth.getSession();

    if (session?.user) {
      const user = session.user;
      const { name, avatar_url } = user.user_metadata;

      const userDiv = document.getElementById("user-info");
      userDiv.innerHTML = `
        <img src="${avatar_url}" alt="avatar" class="w-12 h-12 rounded-full" />
        <span class="font-semibold">${name}</span>
      `;

      document.getElementById("login-btn")?.remove();

      await supabase.from("users").upsert({
        id: user.id,
        username: name,
        avatar_url,
      });
    }
  }

  checkSession();
</script>
