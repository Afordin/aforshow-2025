<script>
  import { sendEvent } from "../lib/analitycs";

  function newSessionId() {
    const epochSec = Math.floor(Date.now() / 1000);
    const rand = Math.floor(Math.random() * 1e8)
      .toString()
      .padStart(8, "0");
    return `${epochSec}${rand}`;
  }
  const sessionId = newSessionId();

  let lastPath: string | null = null;
  async function onRouteChange() {
    const currentPathname = window.location.pathname;
    const currentSearch = window.location.search;
    const currentHash = window.location.hash;

    const fullPath = currentPathname + currentSearch + currentHash;

    if (lastPath === fullPath) return; // duplicate path

    lastPath = fullPath;

    sendEvent("page_changed", sessionId, {
      path: currentPathname + currentSearch,
      ...(currentHash && { hash: currentHash }),
    });
  }

  onRouteChange();

  window.addEventListener("popstate", onRouteChange);
  window.addEventListener("hashchange", onRouteChange, { passive: true });

  const _push = history.pushState;
  history.pushState = function (...args) {
    _push.apply(this, args);
    onRouteChange();
  };

  const _replace = history.replaceState;
  history.replaceState = function (...args) {
    _replace.apply(this, args);
    onRouteChange();
  };
</script>
